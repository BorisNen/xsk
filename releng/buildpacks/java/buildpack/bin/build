#!/bin/bash
set -ex
set -o pipefail

readonly SCRIPT_DIR=$(realpath "$( dirname "${BASH_SOURCE[0]}" )")

echo "Building ..."

echo "Create Tomcat dir in working dir"
#
## 1. GET ARGS
readonly layersdir=$1
readonly tomcatdir=/usr/local/tomcat
readonly tomcatlayer=${layersdir}/tomcat

mkdir -p ${tomcatlayer}
cp -R  /usr/local/tomcat/* ${tomcatlayer}

zip -r ROOT.war .

# find all war files in workspace and copy them to webapps
find /workspace  -name '*.war' -exec cp -prv '{}' ${layersdir}/tomcat/webapps  ';'
chmod -R 777 $layersdir

echo -e 'launch = true' > "$layersdir/tomcat.toml"
## ========== ADDED ===========
## 8. SET DEFAULT START COMMAND
cat > "$layersdir/launch.toml" <<EOL
[[processes]]
type = "web"
command = "${layersdir}/tomcat/bin/catalina.sh run"
EOL
